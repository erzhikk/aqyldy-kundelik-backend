# Backend — Исправление бизнес-логики создания теста (ClassLevel)

## Контекст проблемы
Текущая модель позволяет создавать тесты с логически некорректной комбинацией:
- предмет одного уровня
- классы другого уровня
- классы разных уровней одновременно

Причина: отсутствует обязательный учебный контекст **уровень класса (ClassLevel)**.

---

## Цель
Сделать **ClassLevel** обязательным атрибутом теста и валидировать согласованность:
- уровня класса
- предмета
- выбранных классов

Backend должен **жёстко запрещать** некорректные состояния, независимо от фронта.

---

## Изменения в модели данных

### TestEntity
Добавить обязательное поле:
- `classLevelId` (FK на ClassLevel)

Тест всегда создаётся в контексте одного уровня класса.

---

## API требования

### Получение уровней классов
```
GET /api/class-levels
```

### Получение предметов по уровню
```
GET /api/subjects?classLevelId={id}
```

### Получение классов по уровню
```
GET /api/classes?classLevelId={id}
```

---

## Валидация при Create / Update Test

При обработке `CreateTestRequest` / `UpdateTestRequest` backend обязан:

1. Проверить, что `classLevelId` указан
2. Проверить, что **все classIds принадлежат этому classLevel**
3. Проверить, что **subject доступен для этого classLevel**

При нарушении:
- вернуть `400 Bad Request`
- сообщение должно быть человекочитаемым

Backend **не должен полагаться на корректность фронта**.

---

## Рекомендации по реализации

- Валидацию вынести в сервисный слой
- Для проверки использовать batch-запросы (без N+1)
- Ошибки возвращать как business validation errors

---

## Done Criteria

- Невозможно создать или обновить тест с классами разных уровней
- Невозможно создать тест с предметом не соответствующего уровня
- Любые некорректные запросы отклоняются backend'ом
